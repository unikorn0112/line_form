<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全齡溫養課程報名</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 500px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: auto; }
        .btn-primary { background-color: #00b900; border: none; font-weight: bold; margin-top: 20px; }
        label { font-weight: bold; margin-top: 15px; }
        .name-hint { font-size: 0.8em; color: #ff4d4d; font-weight: normal; }
    </style>
</head>
<body>
    <div class="container">
        <h3 class="text-center mb-4">全齡溫養課程報名</h3>
        
        <div class="form-group">
            <label>姓名 <span class="name-hint">(請填寫正確大名，方便核對)</span></label>
            <input type="text" id="userName" class="form-control" placeholder="請輸入姓名">
        </div>
        
        <div class="form-group">
            <label>電話</label>
            <input type="tel" id="userPhone" class="form-control" placeholder="請輸入聯絡電話">
        </div>

        <div class="form-group">
            <label>報名課程</label>
            <select id="courseType" class="form-control" onchange="updateDates()">
                <option value="500">500元｜頭眼頸 DIY體驗班</option>
                <option value="2980">2980元｜頭眼頸 日常精修班</option>
            </select>
        </div>

        <div class="form-group">
            <label>選擇場次</label>
            <select id="courseDate" class="form-control"></select>
        </div>

        <input type="hidden" id="payMethod" value="轉帳匯款">

        <button id="submitBtn" class="btn btn-primary btn-block">確認提交</button>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const dateMap = {
            "500": ["3/3 (二) 19:30 ~ 21:30", "3/21 (六) 10:00 ~ 12:00"],
            "2980": ["3/22 (日) 19:30 ~ 21:30"]
        };

        function updateDates() {
            const price = document.getElementById('courseType').value;
            const dateSelect = document.getElementById('courseDate');
            dateSelect.innerHTML = ''; 
            dateMap[price].forEach(date => {
                let opt = document.createElement('option');
                opt.value = date; 
                opt.innerHTML = date;
                dateSelect.appendChild(opt);
            });
        }

        let uID = "";
        async function initLIFF() {
            try {
                await liff.init({ liffId: "2009131497-Rq0Gbi7N" }); 
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                } else {
                    const profile = await liff.getProfile();
                    uID = profile.userId;
                    document.getElementById('userName').value = profile.displayName;
                    updateDates(); 
                }
            } catch (err) { 
                updateDates(); 
            }
        }
        initLIFF();

        document.getElementById('submitBtn').onclick = async function() {
            const name = document.getElementById('userName').value;
            const phone = document.getElementById('userPhone').value;
            const method = document.getElementById('payMethod').value; // 這裡會固定取得 "轉帳匯款"
            const price = document.getElementById('courseType').value;
            const date = document.getElementById('courseDate').value;

            if (!name || !phone) { alert('請填寫完整資訊'); return; }
            this.disabled = true;

            try {
                await fetch('https://script.google.com/macros/s/AKfycbw_EPUH4-FnKPxtLTZSh6mPh18ptD9pbEDH47tvWHcBIJ5v7Eaw99CHS7BSSMbDwvc/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        userId: uID, 
                        userName: name, 
                        phone: phone,
                        payMethod: method, 
                        activity: (price === "500" ? "體驗班" : "精修班") + "(" + date + ")", 
                        price: price
                    })
                });

                // 註記：刪除了原本判斷 LINE Pay 並發送關鍵字的程式碼 (liff.sendMessages)
                
                alert('報名成功\n\n感謝您的報名\n\n請點擊〔確定〕返回對話視窗');
                
                if (liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.close();
                }
            } catch (e) {
                alert('系統錯誤：' + e);
                this.disabled = false;
            }
        };
    </script>
</body>
</html>
