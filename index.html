<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨é½¡æº«é¤Šèª²ç¨‹å ±å</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .container { max-width: 500px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: auto; }
        .btn-primary { background-color: #00b900; border: none; font-weight: bold; margin-top: 20px; }
        label { font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h3 class="text-center mb-4">å…¨é½¡æº«é¤Šèª²ç¨‹å ±å</h3>
        <div class="form-group"><label>å§“å</label><input type="text" id="userName" class="form-control"></div>
        <div class="form-group"><label>é›»è©±</label><input type="tel" id="userPhone" class="form-control" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±"></div>
        <div class="form-group">
            <label>å ±åèª²ç¨‹</label>
            <select id="courseType" class="form-control" onchange="updateDates()">
                <option value="500">500å…ƒï½œé ­çœ¼é ¸ DIYé«”é©—ç­</option>
                <option value="2980">2980å…ƒï½œé ­çœ¼é ¸ æ—¥å¸¸ç²¾ä¿®ç­</option>
            </select>
        </div>
        <div class="form-group"><label>é¸æ“‡å ´æ¬¡</label><select id="courseDate" class="form-control"></select></div>
        <div class="form-group">
            <label>ä»˜æ¬¾æ–¹å¼</label>
            <select id="payMethod" class="form-control">
                <option value="line pay">ä½¿ç”¨ LINE Pay</option>
                <option value="è½‰å¸³åŒ¯æ¬¾">è½‰å¸³åŒ¯æ¬¾</option>
            </select>
        </div>
        <button id="submitBtn" class="btn btn-primary btn-block">ç¢ºèªæäº¤</button>
    </div>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const dateMap = {
            "500": ["3/3 (äºŒ) 19:30 ~ 21:30", "3/21 (å…­) 10:00 ~ 12:00"],
            "2980": ["3/22 (æ—¥) 19:30 ~ 21:30"]
        };
        function updateDates() {
            const price = document.getElementById('courseType').value;
            const dateSelect = document.getElementById('courseDate');
            dateSelect.innerHTML = ''; 
            dateMap[price].forEach(date => {
                let opt = document.createElement('option');
                opt.value = date; opt.innerHTML = date;
                dateSelect.appendChild(opt);
            });
        }
        let uID = "";
        async function initLIFF() {
            try {
                await liff.init({ liffId: "2009131497-Rq0Gbi7N" }); 
                if (!liff.isLoggedIn()) { liff.login(); }
                else {
                    const profile = await liff.getProfile();
                    uID = profile.userId;
                    document.getElementById('userName').value = profile.displayName;
                    updateDates(); 
                }
            } catch (err) { updateDates(); }
        }
        initLIFF();

        document.getElementById('submitBtn').onclick = async function() {
            const name = document.getElementById('userName').value;
            const phone = document.getElementById('userPhone').value;
            const method = document.getElementById('payMethod').value;
            const price = document.getElementById('courseType').value;
            const date = document.getElementById('courseDate').value;

            if (!name || !phone) { alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }
            this.disabled = true;

            try {
                await fetch('https://script.google.com/macros/s/AKfycbw_EPUH4-FnKPxtLTZSh6mPh18ptD9pbEDH47tvWHcBIJ5v7Eaw99CHS7BSSMbDwvc/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        userId: uID, userName: name, phone: phone,
                        payMethod: method, activity: (price==="500"?"é«”é©—ç­":"ç²¾ä¿®ç­") + "(" + date + ")", price: price
                    })
                });
                
                if (liff.isInClient()) {
    // 1. å…ˆç™¼é€è¨Šæ¯
    liff.sendMessages([{
        'type': 'text',
        'text': (method === 'line pay' ? 'line pay ä»˜æ¬¾è³‡è¨Š' : 'å ±åå®Œæˆï¼Œè«‹çµ¦æˆ‘åŒ¯æ¬¾è³‡è¨Š')
    }]).then(() => {
        // 2. ç™¼é€æˆåŠŸå¾Œæ‰å½ˆçª—ï¼Œé€™æœƒé˜»æ–·åŸ·è¡Œ
        alert('ğŸ‰ å ±åæˆåŠŸï¼\n\næ„Ÿè¬æ‚¨çš„é ç´„ï¼Œè«‹é»æ“Šç¢ºå®šè¿”å›å°è©±è¦–çª—ã€‚');
        // 3. ä½¿ç”¨è€…æŒ‰äº†ç¢ºå®šå¾Œï¼Œæ‰åŸ·è¡Œé—œé–‰
        liff.closeWindow();
    }).catch((err) => {
        console.error(err);
        liff.closeWindow();
    });
} else {
    // å¤–éƒ¨ç€è¦½å™¨é‚è¼¯
    alert('ğŸ‰ å ±åæˆåŠŸï¼\n\næ„Ÿè¬æ‚¨çš„é ç´„ï¼Œè«‹é»æ“Šç¢ºå®šè¿”å›å°è©±è¦–çª—ã€‚');
    liff.closeWindow();
                }
            } catch (e) {
                alert('ç³»çµ±éŒ¯èª¤ï¼š' + e);
                this.disabled = false;
            }
        };
    </script>
</body>
</html>
